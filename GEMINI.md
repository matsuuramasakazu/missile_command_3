# 開発ガイドライン

このドキュメントには、このコードベースでの作業に関する重要な情報が含まれています。これらのガイドラインに正確に従ってください。

## コア開発ルール

1. パッケージ管理
   - uv のみを使用し、pip は絶対に使用しないでください。
   - インストール: `uv add package`
   - ツールの実行: `uv run tool`
   - アップグレード: `uv add --dev package --upgrade-package package`
   - 禁止事項: `uv pip install`, `@latest` 構文

2. コード品質
   - すべてのコードに型ヒントが必要です。
   - パブリック API には docstring が必要です。
   - 関数は焦点を絞り、小さくする必要があります。
   - 既存のパターンに正確に従ってください。
   - 行の長さ: 最大 88 文字

3. テスト要件
   - フレームワーク: `uv run --frozen pytest`
   - 非同期テスト: asyncio ではなく anyio を使用してください。
   - カバレッジ: エッジケースとエラーをテストしてください。
   - 新機能にはテストが必要です。
   - バグ修正には回帰テストが必要です。

- ユーザー報告に基づくバグ修正または機能追加のコミットには、以下を追加してください。
  ```bash
  git commit --trailer "Reported-by:<name>"
  ```
  `<name>` はユーザーの名前です。

- Github Issue に関連するコミットには、以下を追加してください。
  ```bash
  git commit --trailer "Github-Issue:#<number>"
  ```
- `co-authored-by` または類似の側面は絶対に使用しないでください。特に、コミットメッセージや PR の作成に使用したツールには言及しないでください。

## プルリクエスト

- 変更内容の詳細なメッセージを作成してください。解決しようとしている問題のハイレベルな説明と、それがどのように解決されているかに焦点を当ててください。明確さを増す場合を除き、コードの具体的な内容には立ち入らないでください。

- レビュアーとして常に `matsuuramasakazu` を追加してください。

- `co-authored-by` または類似の側面は絶対に使用しないでください。特に、コミットメッセージや PR の作成に使用したツールには言及しないでください。

## Python ツール

## コードフォーマット

1. Ruff
   - フォーマット: `uv run --frozen ruff format .`
   - チェック: `uv run --frozen ruff check .`
   - 修正: `uv run --frozen ruff check . --fix`
   - 重要な問題:
     - 行の長さ (88 文字)
     - インポートのソート (I001)
     - 未使用のインポート
   - 行の折り返し:
     - 文字列: 括弧を使用
     - 関数呼び出し: 適切なインデントで複数行
     - インポート: 複数行に分割

2. 型チェック
   - ツール: `uv run --frozen pyright`
   - 要件:
     - Optional の明示的な None チェック
     - 文字列の型絞り込み
     - チェックがパスすればバージョン警告は無視できます。

3. Pre-commit
   - 設定: `.pre-commit-config.yaml`
   - 実行: git commit 時
   - ツール: Ruff (Python)
   - Ruff の更新:
     - PyPI バージョンを確認
     - 設定 rev を更新
     - 最初に設定をコミット

## エラー解決

1. CI 失敗
   - 修正順序:
     1. フォーマット
     2. 型エラー
     3. リンティング
   - 型エラー:
     - 完全な行コンテキストを取得
     - Optional 型を確認
     - 型絞り込みを追加
     - 関数シグネチャを確認

2. 一般的な問題
   - 行の長さ:
     - 括弧で文字列を分割
     - 複数行の関数呼び出し
     - インポートを分割
   - 型:
     - None チェックを追加
     - 文字列型を絞り込む
     - 既存のパターンに合わせる
   - Pytest:
     - anyio pytest マークが見つからない場合、pytest 実行コマンドの先頭に `PYTEST_DISABLE_PLUGIN_AUTOLOAD=""` を追加してみてください。例:
       `PYTEST_DISABLE_PLUGIN_AUTOLOAD="" uv run --frozen pytest`

3. ベストプラクティス
   - コミット前に git status を確認
   - 型チェック前にフォーマッターを実行
   - 変更を最小限に抑える
   - 既存のパターンに従う
   - パブリック API を文書化
   - 徹底的にテスト